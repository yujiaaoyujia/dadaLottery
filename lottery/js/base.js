(function(){if(!$.os){var f={};var d=navigator.userAgent;var a=navigator.platform;var c=d.match(/(Android);?[\s\/]+([\d.]+)?/);var b=d.match(/(iPad).*OS\s([\d_]+)/);var e=d.match(/(iPod)(.*OS\s([\d_]+))?/);var g=!b&&d.match(/(iPhone\sOS)\s([\d_]+)/);if(c){f.android=true;f.version=c[2]}if(g&&!e){f.ios=f.iphone=true;f.version=g[2].replace(/_/g,".")}if(b){f.ios=f.ipad=true;f.version=b[2].replace(/_/g,".")}if(e){f.ios=f.ipod=true;f.version=e[3]?e[3].replace(/_/g,"."):null}$.os=f}})();Number.prototype.add=function(b){var a,d,c;try{d=this.toString().split(".")[1].length}catch(f){d=0}try{c=b.toString().split(".")[1].length}catch(f){c=0}a=Math.pow(10,Math.max(d,c));return(this.mul(a)+b.mul(a))/a};Number.prototype.sub=function(a){return this.add(-a)};Number.prototype.mul=function(b){var a=0;var d=this.toString();var c=b.toString();try{a+=d.split(".")[1].length}catch(f){}try{a+=c.split(".")[1].length}catch(f){}return Number(d.replace(".",""))*Number(c.replace(".",""))/Math.pow(10,a)};Number.prototype.div=function(a){var c=0;var b=0;var f,d;try{c=this.toString().split(".")[1].length}catch(g){}try{b=a.toString().split(".")[1].length}catch(g){}f=Number(this.toString().replace(".",""));d=Number(a.toString().replace(".",""));return(f/d).mul(Math.pow(10,b-c))};Date.prototype.format=function(a){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(a)){a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var b in c){if(new RegExp("("+b+")").test(a)){a=a.replace(RegExp.$1,(RegExp.$1.length==1)?(c[b]):(("00"+c[b]).substr((""+c[b]).length)))}}return a};var ddb={};ddb.version="3.0.1";ddb.isWeixin=/MicroMessenger/i.test(navigator.userAgent);ddb.isApp=/DaDaBusPassenger/i.test(navigator.userAgent);ddb.isAndroidApp=ddb.isApp&&$.os.android;ddb.isIosApp=ddb.isApp&&$.os.ios;var B={};B.url={};B.url.getParam=function(b,a){a=a||location.href;var c=new RegExp("(^|&|\\?|#)"+b+"=([^&]*?)(&|#|$)");var d=a.match(/#.*/)?a.match(/#.*/)[0]:"";a=a.replace(/#.*/,"");if(c.test(d)){return decodeURIComponent(d.match(c)[2])}else{if(c.test(a)){return decodeURIComponent(a.match(c)[2])}else{return""}}};B.url.setParam=function(c,e,b,a){if(typeof c==="undefined"||typeof e==="undefined"||typeof b==="undefined"){return b}var f,d=new RegExp("(^|&|\\?|#)"+c+"=([^&]*?)(&|#|$)"),g=b.match(/#.*/)?b.match(/#.*/)[0]:"";b=b.replace(/#.*/,"");if(a===true){if(d.test(g)){g=g.replace(d,function(i,k,j,h){return k+c+"="+encodeURIComponent(e)+h})}else{f=g.indexOf("#")===-1?"#":"&";g=g+f+c+"="+encodeURIComponent(e)}g=g.replace(d,function(i,k,j,h){return k+c+"="+encodeURIComponent(e)+h});return g+b}else{if(d.test(b)){b=b.replace(d,function(i,k,j,h){return k+c+"="+encodeURIComponent(e)+h})}else{f=b.indexOf("?")===-1?"?":"&";b=b+f+c+"="+encodeURIComponent(e)}}return b+g};B.url.delParam=function(b,a){var c=new RegExp("[?&]"+b+"=[^&#]*&?","g");if(a){return a.replace(c,"")}else{history.replaceState(null,"",location.href.replace(c,""))}};B.url.setHash=function(c,a,b){a=a||location.href;return a.replace(/(?:#(.*))?$/,c)};B.url.parseHash=function(g){var b,f,h={};var a=g.split("?");b=a[0];if(a.length>1){var c,e;f=a[1];c=f.split("&");for(var d=0;d<c.length;d++){if(!c[d]){continue}e=c[d].split("=");h[e[0]]=e[1]}}return{hash:g,tag:b,query:f,param:h}};B.url.serializeArray=function(f){var e={},b;try{f=f.split("&");for(var c=0,a=f.length;c<a;c++){if(!f[c]){continue}b=f[c].split("=");e[b[0]]=b[1]}}catch(d){alert("解析公用参数出错："+d)}return e};B.url.getObj=function(a){var b=B.url.parseHash(a);return b.param};B.url.setObj=function(a,b){$.each(b,function(c,d){a=B.url.setParam(c,d,a)});return a};ddb.wxid=B.url.getParam("wxid")||window.sessionStorage.getItem("ddb_wxid")||1;ddb.dev_status="release";ddb.appid=ddb.wxid==2?"wxfeb03a6635e532d7":"wx72a2b17c7ed41fe8";switch(location.hostname.split(".")[0]){case"loc":case"dev":ddb.dev_status="dev";ddb.appid="wx54125ac4cf97185c";break;case"test":ddb.dev_status="test";ddb.appid="wx72a2b17c7ed41fe8";break;case"pre":ddb.dev_status="pre";break}ddb.sld=ddb.dev_status==="release"?"":ddb.dev_status+".";ddb.host=location.host.replace("static.","");ddb.api="http://"+ddb.sld+"api.buskeji.com/";ddb.wxapi="http://"+ddb.host+"/app/api?parames=";ddb.appkey=ddb.dev_status==="release"?"uwd1c0sxd3621":"pvxdm17jx8rqr";ddb.wxsdk="http://res.wx.qq.com/open/js/jweixin-1.0.0.js";ddb.xhrs=[];ddb.noop=function(){};ddb.fitEnv=function(a){if(ddb.dev_status==="release"){return a}else{return a.replace(/\/\/(dev|test)\./,"//"+location.hostname.split(".")[0]+".")}};ddb.loadJs=function(b,c){var a=document.createElement("script");if(typeof c==="function"){a.onload=c}a.src=b;document.head.appendChild(a)};B.user={};B.user.isLogin=function(){return !!(ddb.cookie("wx_user_id")&&ddb.cookie("wx_mobile")&&ddb.cookie("wx_ddb_token")&&ddb.cookie("wx_device_id"))};B.user.login=function(c,b){c=encodeURIComponent(c||location.href);var a="http://"+ddb.host+"/webapp/login.html?referrer="+c;if(b){location.replace(a)}else{location.href=a}};B.user.clearLogin=function(a){if(ddb.isIosApp&&!a){return}ddb.cookie("wx_user_id","",{path:"/"});ddb.cookie("wx_mobile","",{path:"/"});ddb.cookie("wx_device_id","",{path:"/"});ddb.cookie("wx_ddb_token","",{path:"/"});ddb.cookie("wx_is_bind","",{path:"/"});ddb.removeStoragesBut("ddb_src_id|ddb_wxid|ddb_user_gps|wx_openid_wxid1|wx_openid_wxid2","sessionStorage");ddb.session("appCommon",null);if(typeof a==="function"){a()}else{if(!ddb.isApp){location.reload()}}};B.user.logout=function(c,d){d=d||B.user.login;if(c){var b=(ddb.isWeixin?ddb.wxapi:ddb.api)+"authentication/logout";var a=ddb.isWeixin?{urlType:"app"}:{};ddb.get(b,a).done(function(e){if(+e.ret===0){B.user.clearLogin(d)}else{ddb.msg(e.msg)}}).fail(function(){alert("服务器错误")})}else{B.user.clearLogin(d)}};(function(){function q(){var v=ddb.cookie("wx_mobile");var w=ddb.pgps("ddb_user_gps");var x=(ddb.store("ddbCity")||"").split("/")[1];var y=ddb.session("ddb_src_id");if(v&&v!==ddb.common.mobile){ddb.common.mobile=v;ddb.common.user_id=ddb.cookie("wx_user_id");ddb.common.device_id=ddb.cookie("wx_device_id");ddb.common.ddb_token=ddb.cookie("wx_ddb_token")}if(w){ddb.common.lng=w.lng;ddb.common.lat=w.lat;ddb.common.gps_sampling_time=w.gps_sampling_time}if(x){ddb.common.city_code=x}if(y){ddb.common.ddb_src_id=y}}function n(x){q();x.data=$.extend({},ddb.common,x.data||{});if(!/^https?:/i.test(x.url)){x.url=x.urlType==="app"?x.url:ddb.api+x.url}var v=x.cachekey?ddb.session(x.cachekey):null;var w=$.Deferred();var z;function y(A){if((+A.ret===8001||+A.ret===8002||+A.ret===8003)){if(x.notCheckLogin){B.user.clearLogin();w.reject(A);return}if(B.user.isLogin()){B.user.logout();return}B.user.login();return}if(+A.ret===6001){if(ddb.isWeixin&&!x.notCheckLogin){ddb.getOpenId(0,true)}w.reject(A);return}w.resolve(A)}if(v){y(v);return w.promise()}if(!x.noLoading){ddb.loading.show()}z=$.ajax({type:x.type||"GET",url:x.url,data:x.data,dataType:x.dataType||"json",cache:x.cache||false,timeout:x.timeout||8000,success:function(D,A,C){if(!x.noLoading){ddb.loading.hide()}y(D);console.log("AJAX: "+x.url+"\n ",D);if(x.cachekey&&+D.ret===0){ddb.session(x.cachekey,D)}},error:function(C,A){if(!x.noLoading){ddb.loading.hide()}console.log("网络异常["+A+"]");w.reject(C)}});ddb.xhrs.push(z);if(x.returnXhr){return z}return w.promise()}function f(x,z,D,A){if(typeof z==="function"){A=D;D=z;z={}}q();z=$.extend({},ddb.common,z||{});var v=$.Deferred();var C=z.cachekey;var w=C?ddb.session(C):null;var E;if(!/^https?:/i.test(x)){x=z.urlType==="app"?x:ddb.api+x}function y(F){if((+F.ret===8001||+F.ret===8002||+F.ret===8003)){if(z.notCheckLogin){B.user.clearLogin();v.reject(F);return}if(B.user.isLogin()){B.user.logout();if(typeof D==="function"){D(F)}return}B.user.login();return}if(+F.ret===6001){if(ddb.isWeixin&&!z.notCheckLogin){ddb.getOpenId(0,true)}v.reject(F);return}if(typeof D==="function"){D(F)}v.resolve(F)}if(w){y(w);return v.promise()}if(!z.noLoading){ddb.loading.show()}E=$.ajax({url:x,type:"GET",data:z,dataType:z.dataType||"json",cache:z.cache||false,timeout:z.timeout||8000,success:function(H,F,G){ddb.loading.hide();console.log("GET: "+x+"\n ",H);y(H);if(C&&+H.ret===0){ddb.session(C,H)}},error:function(G,F){ddb.loading.hide();if(typeof A==="function"){A(G,F)}console.log("网络异常["+F+"]");v.reject(G)}});ddb.xhrs.push(E);if(z.returnXhr){return E}return v.promise()}function k(x,z,D,A){q();z=$.extend({},ddb.common,z||{});if(!/^https?:/i.test(x)){x=z.urlType==="app"?x:ddb.api+x}var v=$.Deferred();var C=z.cachekey;var w=C?ddb.session(C):null;var E;function y(F){if((+F.ret===8001||+F.ret===8002||+F.ret===8003)){if(B.user.isLogin()){B.user.logout();return}B.user.login();return}if(typeof D==="function"){D(F)}v.resolve(F)}if(w){y(w);return v.promise()}if(!z.noLoading){ddb.loading.show()}E=$.ajax({url:x,type:"POST",data:z,dataType:z.dataType||"json",cache:z.cache||false,timeout:z.timeout||8000,success:function(F){ddb.loading.hide();console.log("POST: "+x+"\n ",F);y(F);if(C&&+F.ret===0){ddb.session(C,F)}},error:function(G,F){ddb.loading.hide();if(typeof A==="function"){A(G,F)}console.log("网络异常["+F+"]");v.reject()}});ddb.xhrs.push(E);return v.promise()}function s(x,w,C,A){var z=new FormData();x=ddb.api+x;q();w=$.extend({},ddb.common,w);for(var y in w){if(w.hasOwnProperty(y)&&y!=="hasOwnProperty"){if(w[y].name){z.append(y,w[y],w[y].name)}else{z.append(y,w[y])}}}ddb.loading.show();$.ajax({url:x,dataType:"json",type:"POST",data:z,timeout:w.timeout||20000,cache:false,processData:false,contentType:false,success:function(D){ddb.loading.hide();v(D);console.log("UPLOAD: "+x+"\n ",D)},error:function(E,D){ddb.loading.hide();if(typeof A==="function"){A(E,D)}console.log("上传出错["+D+"]")}});function v(D){if(+D.ret===8001||+D.ret===8002||+D.ret===8003){if(B.user.isLogin()){B.user.logout();return}B.user.login();return}C(D)}}function u(x,z,D,A){if(typeof z==="function"){A=D;D=z;z={}}q();z=$.extend({},ddb.common,z||{});var v=$.Deferred();var C=z.cachekey;var w=C?ddb.session(C):null;var E;if(!/^https?:/i.test(x)){x=z.urlType==="app"?x:ddb.api+x}function y(F){if(typeof D==="function"){D(F)}v.resolve(F)}if(w){y(w);return v.promise()}if(!z.noLoading){ddb.loading.show()}E=$.ajax({url:x,type:"GET",data:z,dataType:"jsonp",cache:z.cache||false,jsonp:"cb",timeout:z.timeout||8000,success:function(F){ddb.loading.hide();console.log(F);y(F);if(C&&+F.ret===0){ddb.session(C,F)}console.log("JSONP: "+x+"\n ",F)},error:function(G,F){ddb.loading.hide();if(typeof A==="function"){A(G,F)}console.log("网络异常：",G);v.reject(G)}});ddb.xhrs.push(E);return v.promise()}function i(x,y){if(B.url.getParam("hasOpenid")){return}x=x||location.href;y=y||ddb.isWeixin;var w=B.url.setParam("referrerSrc",x,"http://"+ddb.host+"/wechat_menu/getOpenId");var v=w;if(y){v=B.url.setObj("https://open.weixin.qq.com/connect/oauth2/authorize",{appid:ddb.appid,redirect_uri:w,response_type:"code",scope:"snsapi_base"})+"#wechat_redirect"}location.replace(v)}function l(x,z,w){w=w||{};if(typeof z==="undefined"){return v(x)}else{if(z===null||z===""){return A(x,w)}else{return y(x,z,w)}}function y(E,G,D){var C=D.expires;var I=D.path;var F=D.domain;var H=D.secure;if(typeof C==="number"){C=new Date(new Date().getTime()+C*86400000)}document.cookie=E+"="+escape(G)+(C?"; expires="+C.toUTCString():"")+(I?"; path="+I:"")+(F?"; domain="+F:"")+(H?"; secure":"");return true}function v(D){var C=document.cookie.match(new RegExp("(^| )"+D+"=([^;]*)(;|$)"));if(C!==null){return unescape(C[2])}return""}function A(D,C){C.expires=new Date(0);return y(D,"",C)}}function g(x,w,v){w=w||"http://"+ddb.host+"/webapp/"+x;if(v){window.history.replaceState(history.state,"",w)}location=w}function r(w,v,A){try{window[w].setItem("test-storage","test");window[w].removeItem("test-storage")}catch(y){alert("您开启了无痕模式或禁用了缓存，为了能享受更好的服务，请更改您的设置。");return}if(typeof A==="undefined"){try{return JSON.parse(window[w].getItem(v))}catch(x){return window[w].getItem(v)}}else{if(A===null||A===""){return window[w].removeItem(v)}else{try{return window[w].setItem(v,JSON.stringify(A))}catch(z){if(w==="sessionStorage"){ddb.removeStoragesByKeyContains("/",w)}else{ddb.removeStoragesBut("ddbCity|isAward|ddbSearch|travel_city_code|waitBusTips",w)}return window[w].setItem(v,JSON.stringify(A))}}}}function j(v,w){return r("localStorage",v,w)}function b(v,w){return r("sessionStorage",v,w)}function t(y,x){var z=window[x||"sessionStorage"];var v=z.length;var w;if(!z){alert("为了能享受更好的服务，请关闭浏览器的无痕模式！");return}while(v){v--;w=z.key(v);if(w.indexOf(y)!==-1){z.removeItem(w)}}}function h(y,x){y=y.split("|");var z=window[x||"localStorage"];var v=z.length;var w;if(!z){alert("为了能享受更好的服务，请关闭浏览器的无痕模式！");return}while(v){v--;w=z.key(v);if(y.indexOf(w)===-1){z.removeItem(w)}}}function a(v){if(ddb.dev_status==="release"&&ddb.debugMobile!==ddb.cookie("wx_mobile")){return}console.log("Debug: ",v)}function d(y,A,x,w){var v=A.order_number;var C=B.url.setParam("order_number",v,"order_details.html");if(A.isCharteredBus){C=B.url.setObj("chartered_order_details.html",{order_id:v,use_native_page:false})}C=B.url.setObj(C,{pay_status:y,line_type:A.line_type});if(A.order_type===1){C=B.url.setObj("product_order_details.html",{order_type:A.order_type,order_number:v})}x=x||ddb.noop;w=w||x;switch(y){case"ok":ddb.loading.show();setTimeout(z,1500);return;case"cancel":case"fail":D();return}function z(){if(!A.order_type){var F="order/pay_confirm";var E={order_number:v,dada_flag:1};if(A.isCharteredBus){F="chartered/pay_confirm";E={order_id:v,payment_id:A.pay_order_info.payment_id}}ddb.get(F,E,function(H){if(+H.ret!==0){alert(H.msg);return}switch(H.data.status){case"success":G(H.data);return;case"error invalid_order_number":alert("订单号错误");break;case"order_unpaid":alert("订单未支付");break;case"order_has_been_canceled":alert("订单已取消");break;case"failed":break}C=B.url.setParam("pay_status","fail",C);D();function G(I){if(!ddb.store("isAward")){ddb.pgps("award",$.extend(ddb.pgps("award")||{},{show_award:I.show_award,award_title:I.award_title,award_msg:I.award_msg}));ddb.store("isAward",1)}ddb.pgps("activeInfo",{show_active:I.show_active,active_title:I.active_title,share_type:I.share_type});if(!A.isCharteredBus){ddb.removeStoragesByKeyContains("member/get_ticket_count?date=");ddb.pgps("home/get_line_recommend",null)}x(v);if(A.isCharteredBus){return}if(!A.isCharteredBus){C=ddb.fitEnv(I.success_url)||C}location.href=C}})}else{if(A.order_type===1){ddb.post("goods_order/pay_confirm",{order_number:v},function(G){if(+G.ret!==0){alert(G.msg);return}switch(+G.data.order_info.status){case 2:ddb.removeStoragesByKeyContains("member/get_ticket_count?date=");ddb.pgps("home/get_line_recommend",null);x(v);return;case 1:alert("订单未支付");break;case 3:alert("订单已关闭");break;default:break}D()})}}}function D(){w(v);if(A.isCharteredBus){return}if(A.order_type===1){return}location.href=C}}function c(A,x,w){if(!A.order_number){alert("订单号无效 T_T");return}var v=A.order_number;x=x||ddb.noop;w=w||x;switch(+A.pay_type){case 1:setTimeout(C,1500);break;case 2:z(2);break;case 4:y();break;case 8:ddb.cookie("fqlpay_order_number",v,{expires:1});location=A.pay_order_info.fenqile_url;break}function z(D){var E=ddb.common.version<"2.7.0";if(D===1){A.payChannel="wxpay";A.payInfo=E?A.pay_order_info.wx_prepay_id:JSON.stringify(A.pay_order_info.wx_params)}else{if(D===2){A.payChannel="alipay";A.payInfo=A.pay_order_info.alipay_params}}if(E){ddb.appCall("pay",A.payChannel,A.payInfo)}else{ddb.appCall("payment",A.payChannel,A.payInfo,function(F){ddb.Popup.close();if(F){d("ok",A,x,w)}else{d("fail",A,x,w)}})}ddb.Popup.confirm({title:"支付提醒",content:"是否已经完成支付",cancelText:"遇到问题",okText:"完成支付",okCall:function(){d("ok",A,x,w)},cancelCall:function(){d("ok",A,x,w)}})}function C(){if(ddb.isWeixin){if(ddb.dev_status!=="release"){alert("测试公众号不支持微信支付");return}if(A.pay_order_info&&A.pay_order_info.wx_params){var D=A.pay_order_info.wx_params;D={appId:D.appid,timeStamp:D.time_stamp.toString(),nonceStr:D.nonce_str,"package":"prepay_id="+D.prepay_id,signType:D.sign_type,paySign:D.sign};WeixinJSBridge.invoke("getBrandWCPayRequest",D,function(E){if(E.err_msg==="get_brand_wcpay_request:ok"){d("ok",A,x,w)}else{if(E.err_msg==="get_brand_wcpay_request:cancel"){d("cancel",A,x,w)}else{d("fail",A,x,w)}}});return}A.urlType="app";A.wxid=1;ddb.get("/app/weixinOerderPay/",A,function(E){if(+E.ret===0){WeixinJSBridge.invoke("getBrandWCPayRequest",E.msg,function(F){if(F.err_msg==="get_brand_wcpay_request:ok"){d("ok",A,x,w)}else{if(F.err_msg==="get_brand_wcpay_request:cancel"){d("cancel",A,x,w)}else{d("fail",A,x,w)}}})}else{alert("获取微信支付包失败："+E.msg)}})}else{if(ddb.isApp){A.payChannel="wxpay";A.payInfo=A.pay_order_info.wx_prepay_id;z(1)}}}function y(){var E="http://"+ddb.host+"/webapp/";var D={order_number:v,return_url:E+"pay_success.html?pay_type=aliwebpay&order_number="+v};if(A.isCharteredBus){if(A.pay_order_info&&A.pay_order_info.html_text){$(A.pay_order_info.html_text).hide().appendTo("body")}else{w(v)}return}if(A.order_type===1){if(A.pay_order_info&&A.pay_order_info.alipay_html){$(A.pay_order_info.alipay_html).hide().appendTo("body")}else{w(v)}return}ddb.get("order/h5_alipay",D,function(F){if(+F.ret!==0){alert(F.msg);return}x(v);$(F.data.alipay_html).hide().appendTo("body")})}}function o(v){return ddb.Toast.show(v)}function p(x,v){var w=$("."+x);$.each(w,function(D,H){$(H).removeClass("m-marquee");var E=$(H).html();var F=$(H).data("html");if(!v){v="default"}if(F&&v.indexOf("change")===-1){E=F}$(H).html("<span>"+E+"</span>");var y=$(H).width()-parseFloat($(H).css("padding-left"));var A=$(H).find("span").width();if(A>y){$(H).data("html",E);$(H).html("<p><label><span>"+E+"</span><span>"+E+"</span></label></p>");$(H).addClass("m-marquee");var z=parseFloat($(H).find("span").css("padding-right"));var G=$(H).find("label");G.width(2*(A+z));if(v.indexOf("auto")!==-1){var C=3*Math.floor(A/y)+7;if(C>20){C=20}G[0].style.cssText+="-webkit-animation: marquee "+C+"s linear 1.5s infinite;";G[0].style.cssText+="animation: marquee "+C+"s linear 1.5s infinite;"}}else{$(H).html(E)}})}function m(w){document.title=w;if($.os.ios){var v=$('<iframe src="about:blank" style="display:none;"></iframe>').on("load",function(){setTimeout(function(){v.off("load").remove()},0)}).appendTo("body")}}ddb.jump=g;ddb.initCommon=q;ddb.ajax=n;ddb.get=f;ddb.post=k;ddb.upload=s;ddb.getJsonp=u;ddb.store=j;ddb.pgps=b;ddb.session=b;ddb.removeStoragesByKeyContains=t;ddb.removeStoragesBut=h;ddb.cookie=l;ddb.payOrder=c;ddb.debug=a;ddb.msg=o;ddb.payCallback=d;ddb.getOpenId=i;ddb.marqueeLine=p;ddb.setTitle=m;if($.os.ios&&/MQQBrowser/i.test(navigator.userAgent)){ddb.session=ddb.pgps=ddb.store}ddb.getWxUserInfo=function(y,w,x){y=(y||location.href).replace(/\/\/\w+\.wechat/,"//wechat");w=w==="userinfo"?"snsapi_userinfo":"snsapi_base";x=x||ddb.appid;var v=["https://open.weixin.qq.com/connect/oauth2/authorize?","appid="+x,"&redirect_uri="+encodeURIComponent(y),"&response_type=code","&scope="+w,"#wechat_redirect"].join("");location=v};ddb.abortXHRs=function(){ddb.xhrs.forEach(function(v){v.abort();console.log("Abort XHR: ",v)});ddb.xhrs=[]};ddb.showShareit=function(){if(!ddb.isWeixin){alert("请在嗒嗒微信众号中分享");return}var v=document.getElementById("shareit");if(!v){$('<div id="shareit"><p>点击右上角分享</p></div>').appendTo("body").on("click",function(w){this.style.display="none"})}else{v.style.display="block"}};ddb.getPageLink=function(w){var v={item_type:w.item_type||1,line_code:w.line_code,noLoading:true};if(w.startDate){v.start_date=w.start_date}ddb.get("line/get_line_config",v,function(z){if(+z.ret===0){var y={};y.type={};y.list=z.data.item_list.slice(0,3).map(function(F,D,A){var G=F.title;var E=18;var C="...";switch(A.length){case 1:break;case 2:E=16;break;case 3:E=8;break}return F});if(y.list.length===2&&y.list.every(x)){y.type.less8=true}w.callback(y)}else{alert(z.msg)}function x(A){var C=A.title.replace(/<[^>]+>/g,"");return C.length<8}})};ddb.device=(function(){var v=window.devicePixelRatio||1;if(screen.width===document.documentElement.clientWidth){return{width:screen.width*v,height:screen.height*v,dpr:v}}return{width:screen.width,height:screen.height,dpr:v}})();ddb.common={version:ddb.version,wxid:ddb.wxid,user_id:"0",login_type:1,device_type:3,screen:ddb.device.width+":"+ddb.device.height+"|"+ddb.device.dpr,source:ddb.isWeixin?3:5};var e=B.url.getParam("ddb_src_id");if(e){ddb.session("ddb_src_id",e)}if(ddb.wxid){window.sessionStorage.setItem("ddb_wxid",ddb.wxid)}q()})();ddb.inPath=function(a){return new RegExp("/("+a+")/","i").test(location.pathname)};ddb.fileName=location.pathname.slice(location.pathname.lastIndexOf("/")+1);ddb.wx={};ddb.wx.getUserinfo=function(a,b){if(!ddb.isWeixin){return}if(typeof a==="function"){b=a}a=$.extend({urlType:"app",cachekey:"app/get_wx_userinfo?wxid="+(a.wxid||ddb.wxid),notCheckLogin:true},a||{});ddb.get("/app/get_wx_userinfo",a,function(c){if(c.data){ddb.wxUserinfo=c.data;ddb.unionid=ddb.wxUserinfo.unionid;if(ddb.wxUserinfo.openid){ddb.session("wx_openid_wxid"+a.wxid,ddb.wxUserinfo.openid)}typeof b==="function"&&b(ddb.wxUserinfo)}})};ddb.wx.getInfo=function(a,b){if(!ddb.isWeixin){return}if(typeof a==="function"){b=a;a=location.href.split("#")[0]}ddb.get(ddb.wxapi+"wechat_api/jssdk",{urlType:"app",wxUrl:a,noLoading:true},function(c){if(0!==+c.ret){return}ddb.JSSDK_CFG=c.JSSDK_CFG;ddb.openid=c.JSSDK_CFG.open_id;if(ddb.openid){ddb.session("wx_openid_wxid"+ddb.wxid,ddb.openid)}if(typeof b==="function"){b(c.JSSDK_CFG)}})};ddb.wx.shareConfig={title:"美好生活从嗒嗒开始，百万豪礼大放送",desc:"嗒嗒巴士2周年庆，乘车礼券天天送，今天领完明天还能继续领哦。",link:"http://"+ddb.host+"/h5/active/lottery/index.html",imgUrl:"http://"+ddb.host+"/webapp/image/side_avatar_default.png",timeline:{imgUrl:"http://"+ddb.host+"/webapp/image/side_avatar_default_memory.png"},appMessage:{},QQ:{},QZone:{}};ddb.wx.setConfig=function(a,b){if(ddb.wx.hasConfig){return}wx.config($.extend({debug:b||false,appId:a.msg.appId,timestamp:a.msg.timestamp,nonceStr:a.msg.nonceStr,signature:a.msg.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareQZone","chooseImage","previewImage","openLocation","getLocation","hideMenuItems","showMenuItems","closeWindow","getNetworkType"]},a.config||{}));ddb.wx.hasConfig=true};ddb.wx.share=function(a,b){if(!ddb.isWeixin||!window.wx){return}var c=a.isShare||B.url.getParam("share");if(1==c){$("nav button").addClass("showNone").filter(".publicNum").removeClass("showNone")}a.JSSDK_CFG=a.JSSDK_CFG||ddb.JSSDK_CFG;ddb.wx.hideShareMenu(a.JSSDK_CFG);if(a.url){ddb.wx.getInfo(a.url,d)}else{if(a.JSSDK_CFG){d(a.JSSDK_CFG)}else{ddb.wx.getInfo(d)}}function d(e){ddb.wx.shared=true;ddb.wx.setConfig(e,b);wx.ready(function(){var f=$.extend({},ddb.wx.shareConfig,a.JSSDK_Share);var g={title:f.title,desc:f.desc,link:f.link,imgUrl:f.imgUrl};g.success=function(i){if(document.getElementById("shareit")){$("#shareit").hide()}if(window.MtaH5&&a.mtaid){MtaH5.clickStat("wxshare."+a.mtaid+"."+i.errMsg.replace(":ok",""))}};wx.onMenuShareTimeline($.extend([],g,f.timeline));wx.onMenuShareAppMessage($.extend([],g,f.appMessage));wx.onMenuShareQQ($.extend([],g,f.QQ));wx.onMenuShareQZone($.extend([],g,f.QZone));var h=["menuItem:share:appMessage","menuItem:share:timeline","menuItem:share:qq","menuItem:share:QZone"];if(f.channels){h=f.channels.split(",").map(function(i){return h[i-1]})}ddb.wx.showShareMenu(e,h);setTimeout(function(){ddb.wx.showShareMenu(e,h)},1000)});wx.error(function(f){console.log(f)})}};ddb.wx.hideShareMenu=function(b,a){if(!ddb.isWeixin||!window.wx){return}b=b||ddb.JSSDK_CFG;if(b){c(b)}else{ddb.wx.getInfo(c)}function c(d){ddb.wx.setConfig(d);wx.ready(function(){a=a||["menuItem:share:appMessage","menuItem:share:timeline","menuItem:share:qq","menuItem:share:QZone"];wx.hideMenuItems({menuList:a})})}};ddb.wx.showShareMenu=function(c,b){if(!ddb.isWeixin||!window.wx){return}c=c||ddb.JSSDK_CFG;if(c){a(c)}else{ddb.wx.getInfo(a)}function a(d){ddb.wx.setConfig(d);wx.ready(function(){b=b||["menuItem:share:appMessage","menuItem:share:timeline","menuItem:share:qq","menuItem:share:QZone"];wx.showMenuItems({menuList:b})})}};ddb.wx.getFollowStatus=function(b){if(!ddb.isWeixin){return}if(ddb.JSSDK_CFG){a(ddb.JSSDK_CFG)}else{ddb.wx.getInfo(a)}function a(c){ddb.get("/wechat_api/isSubscribe",{urlType:"app",dataType:"text",openid:c.open_id,notCheckLogin:true},function(d){var e=d!=="0";b(e)})}};ddb.wx.jumptoCode=function(b){if(!ddb.isWeixin){alert("请在微信客户端打开链接！");return}b=b||{};var c="https://open.weixin.qq.com/connect/oauth2/authorize";var a=B.url.setObj(c,{appid:b.appid||ddb.appid,redirect_uri:b.returl||location.href,scope:b.base?"snsapi_base":"snsapi_userinfo",response_type:"code"})+"#wechat_redirect";location.replace(a)};ddb.wx.gotoPublic=function(){location.href="http://mp.weixin.qq.com/s?__biz=MzAxNDMzNjc2MQ==&mid=209057391&idx=1&sn=c3686736a269a755c2b3bbb69dcddf91&scene=1&key=1936e2bc22c2ceb5f0422d19def4dd7e2ead657bd6a2be972adadb5206e9105a41e4bcaeaabb99c6bb8a0a9c37a78489&ascene=1&uin=MTAzNDg1ODg4MQ%3D%3D&devicetype=Windows+8&version=61000721&pass_ticket=Koa33YxOOGuMY5d5XE%2BTNfpOefmOQ0oQUIO%2BVO0f9PbEwF0GPMj%2BeH1mkKvSd45M";return false};ddb.jumpCommonUrl=function(b){var a="http://"+ddb.sld+"jump.buskeji.com/common/load?page="+b;a=B.url.setObj(a,{version:ddb.version,device_type:3,city_code:ddb.store("ddbCity")?ddb.store("ddbCity").split("/")[1]:"0755"});window.location=a};ddb.scrollRefresh=function(b,d){if(typeof b==="function"){d=b;b=document.body}var a=b.scrollHeight-document.documentElement.clientHeight;var c=a-b.scrollTop;if(c<100){d()}};ddb.setShare=function(a,b){if(!ddb.isWeixin&&!ddb.isApp){return}ddb.wx.shared=true;a.notCheckLogin=true;a.noLoading=true;ddb.get("share/get_share_url",a,function(f){if(+f.ret===0){var c=f.data.share_channel_list.map(function(d){return d.share_channel_id});var e={title:f.data.share_title,desc:f.data.share_detail,link:ddb.fitEnv(f.data.share_url),channels:c.join(",")};f.data.share_channel_list.forEach(function(g){var d={};if(g.share_title){d.title=g.share_title}if(g.share_detail){d.desc=g.share_detail}if(g.share_url){d.link=g.share_url}if(g.share_icon){d.imgUrl=g.share_icon}switch(+g.share_channel_id){case 1:e.appMessage=d;break;case 2:e.timeline=d;break;case 3:e.QQ=d;break;case 4:e.QZone=d;break}});ddb.wx.share({mtaid:a.mtaid,JSSDK_Share:e});if(typeof b==="function"){b($.extend({imgUrl:ddb.wx.shareConfig.imgUrl,appCfg:JSON.stringify(f.data)},e))}}})};ddb.ui={};ddb.tl={};ddb.tl.fixPrice=function(e){if(typeof e==="undefined"||!e){return e}var f=e.toString();if(e==0){return"0"}if(f.indexOf(".")==-1){return e}var c=f.split(".");var b=c[1];if(c[0]==0){c[0]=0}if(b.length>=2){b=b.substr(0,2)}for(var d=0,a=b.length;d<a;d++){if(b.length>0&&b.charAt(b.length-1)==0){b=b.slice(0,-1)}}return b.length>0?c[0]+"."+b:c[0]};ddb.tl.loadContent=function(a,b,c){return $.ajax({url:a,dataType:"html",timeout:b.timeout||15000,cache:true,data:b,success:function(d){c&&c(d)},error:function(d){alert("网络异常!")}})};ddb.tl.loadCss=function(a){$("<link>").attr({rel:"stylesheet",type:"text/css",href:a}).appendTo("head")};ddb.tl.clone=function(a){return JSON.parse(JSON.stringify(a))};ddb.Popup=(function(){var i,m,g,o,p,l={center:{top:"50%",left:".5rem",right:".5rem","border-radius":".2rem"}},k={msg:'<div class="popup-content popup-msg {_class}">{content}</div>',alert:'<div class="popup-title {_class}">{title}</div><div class="popup-content {_class}">{content}</div><div id="ddb_popup_btn_container"><a data-target="closePopup" data-icon="checkmark">{ok}</a></div>',tips:'<div class="popup-tips-title">{title}</div><div class="popup-tips-content">{content}</div>',confirm:'<div class="popup-title {_class}">{title}</div><div class="popup-content {_class}">{content}</div><div id="ddb_popup_btn_container"><a class="cancel" data-icon="close">{cancel}</a><a data-icon="checkmark">{ok}</a></div>',intro:'<div class="popup-title {_class}">{title}</div><div class="popup-content {_class}">{content}</div><div id="ddb_popup_btn_container"><a class="ddb_popup_intro_ok" data-icon="checkmark">{ok}</a></div>',loading:'<i class="icon spinner"></i>',center:'<div class="popup_tips {_class}">{_img}<div class="popup_tips_title">{title}</div><div class="popup_tips_text1">{text1}</div><div class="popup_tips_text2">{text2}</div></div>'};var h=function(){$("body").append('<div id="ddb_popup"></div><div id="ddb_popup_mask"></div>');g=$("#ddb_popup_mask");m=$("#ddb_popup");d()};var c={};c.show=function(t){var s=k.loading;r({html:s,pos:"loading",opacity:0.1,animation:true,clickMask2Close:false})};c.hide=function(){j()};var r=function(u,x){var w={height:undefined,width:undefined,opacity:0.6,html:"",pos:"center",clickMask2Close:true,showCloseBtn:true,onShow:undefined};$.extend(w,u);p=w.clickMask2Close;g.css("opacity",w.opacity);m.attr({style:"","class":""});w.width&&m.width(w.width);w.height&&m.height(w.height);var y=$.type(w.pos);if(y=="object"){m.css(w.pos)}else{if(y=="string"){if(l[w.pos]){m.css(l[w.pos]);var t=w.pos.indexOf("top")>-1?"top":(w.pos.indexOf("bottom")>-1?"bottom":"defaultAnim")}else{m.addClass(w.pos)}}else{console.error("错误的参数！");return}}g.show();var v;if(w.html){v=w.html}else{if(w.url){v=J.Page.loadContent(w.url)}else{if(w.tplId){v=template(w.tplId,w.tplData)}}}if(w.showCloseBtn){v+='<div id="tag_close_popup" data-target="closePopup" class="icon cancel-circle"></div>'}m.html(v).show();w.onShow&&w.onShow.call(m);if(w.pos=="center"){var s=m.height();m.css("margin-top","-"+s/2+"px")}x&&x()};var j=function(s){g.hide();m.hide().empty()};var d=function(){g.on("click",function(){p&&j()});m.on("click",'[data-target="closePopup"]',function(){j()})};var b=function(u,t,v){var s=k.alert.replace("{title}",u).replace("{content}",t).replace("{ok}",v||"确定");r({html:s,pos:"center",opacity:0.6,showCloseBtn:false})};var a=function(u,t,v){var s=k.tips.replace("{title}",u).replace("{content}",t);r({html:s,pos:"center",opacity:0.4,showCloseBtn:false})};var f=function(x,y,w,u,A,s,v,t){if($.isPlainObject(x)){var z=$.extend({className:"",title:"",content:"",okText:"",cancelText:"",clickMask2Close:true,okCall:function(){},cancelCall:function(){}},x);t=z.clickMask2Close;x=z.className;y=z.title;w=z.content;u=z.cancelText;A=z.okText;s=z.okCall;v=z.cancelCall}else{u=u||"取消";A=A||"确定"}r({html:k.confirm.replace("{title}",y).replace("{content}",w).replace("{cancel}",u).replace("{ok}",A).replace(/{_class}/g,x),pos:"center",opacity:0.4,showCloseBtn:false,clickMask2Close:t});$('#ddb_popup_btn_container [data-icon="checkmark"]').on("click",function(){s.call(this);j()});$('#ddb_popup_btn_container [data-icon="close"]').on("click",function(){v.call(this);j()})};var n=function(u,y,v,s,w,x){if($.isPlainObject(u)){var t=$.extend({className:"",title:"",content:"",okText:"",clickMask2Close:true,okCall:function(){}},u);x=t.clickMask2Close;u=t.className;y=t.title;v=t.content;s=t.okText;w=t.okCall}else{s=s||"确定"}r({html:k.intro.replace("{title}",y).replace("{content}",v).replace("{ok}",s).replace(/{_class}/g,u),pos:"center",opacity:0.4,showCloseBtn:false,clickMask2Close:x});$('#ddb_popup_btn_container [data-icon="checkmark"]').on("click",function(){w.call(this);j()})};var e=function(t){if(i){clearTimeout(i)}var s=k.msg.replace("{content}",t);r({html:s,pos:"center",opacity:0.6,showCloseBtn:false})};var q=function(s,u,t){if(typeof s!=="string"){t=u;u=s;s='<img src="/webapp/image/icon_success.png">'}s=s||"";u=$.extend({className:"",title:"",text1:"",text2:"",delay:3000},u||{});t=t||k.center.replace("{_img}",s).replace("{title}",u.title).replace("{text1}",u.text1).replace("{text2}",u.text2).replace("{_class}",u.className);r({html:t,pos:"center",opacity:0,showCloseBtn:false},function(){$("#ddb_popup").css("background","rgba(0, 0, 0, 0)").addClass(u.className)});if(i){clearTimeout(i)}i=setTimeout(function(){j();u.callback&&u.callback()},u.delay)};h();return{loading:c,show:r,close:j,alert:b,tips:a,msg:e,confirm:f,intro:n,center:q}})();ddb.Toast=(function(c){var f="toast",b,a,i={toast:'<a href="#">{value}</a>',success:'<a href="#"><i class="icon checkmark-circle"></i>{value}</a>',error:'<a href="#"><i class="icon cancel-circle"></i>{value}</a></div>',info:'<a href="#"><i class="icon info-2"></i>{value}</a>'};var g=function(){c("body").append('<div id="ddb_toast"></div>');b=c("#ddb_toast");d()};var e=function(){b.hide();b.empty()};var h=function(m,j,l){if(a){clearTimeout(a)}j=j||"toast";l=l||3000;var k=j.split(/\s/);f=k[0];b.attr("class",j).html(i[f].replace("{value}",m)).show();if(l!==0){a=setTimeout(e,l)}};var d=function(){b.on("click",'[data-target="close"]',function(){e()})};g();return{show:h,hide:e}})($);ddb.loading=(function(){var a=document.getElementById("ddb-loading")||$('<div id="ddb-loading"><i></i></div>').appendTo("body")[0];return{show:function(b){if(!a){return}a.style.display="block";if($(a).html!=="<i></i>"){$(a).html("<i></i>")}if(b){$(a).html("<span><p><i></i>"+b+"</p></span>")}},hide:function(){if(!a){return}a.style.display="none"}}})();ddb.getChatTokenCallback=function(d){var a=ddb.cookie("wx_user_id");var c="chat_token_"+a;var b=ddb.session(c);if(!a){return}if(b){d(b)}else{ddb.get("chat/get_rongcloud_token",function(e){if(+e.ret!==0){alert(e.msg);return}if(!e.data.token){alert("token 值为空");return}console.log("get token: ",b);ddb.session(c,e.data.token);d(e.data.token)})}};window.oAlert=window._alert=window.alert;window.alert=ddb.Toast.show;if(ddb.dev_status==="release"&&!B.url.getParam("debug")){window.onerror=console.log=console.error=console.debug=console.warn=console.info=ddb.noop}ddb.getCityByCode=function(a,b){var c="";b=b||ddb.CITYS;if(!b){return c}b.some(function(d){if(d.code==a){c=d.city;return true}});return c};ddb.initApp=(function initApp(){ddb.app=window.DDBApp||window.android;if(ddb.isApp){document.documentElement.classList.add("ddbapp");if(ddb.isIosApp){document.documentElement.classList.add("iosapp")}ddb.common=ddb.session("appCommon");if(!ddb.common||!B.user.isLogin()){var a=ddb.app?ddb.app.getCommonParams():ddb.cookie("ddb_app_general")||location.search.substring(1);if(ddb.isAndroidApp){a=a||ddb.cookie("ddb_app_general")}if(ddb.dev_status!=="release"){a=ddb.cookie("ddb_app_general")||ddb.store("ddb_app_general")}ddb.common=B.url.serializeArray(decodeURIComponent(a));ddb.cookie("wx_mobile",(ddb.common.mobile||""),{path:"/"});ddb.cookie("wx_user_id",(ddb.common.user_id||""),{path:"/"});ddb.cookie("wx_device_id",(ddb.common.device_id||""),{path:"/"});ddb.cookie("wx_ddb_token",(ddb.common.ddb_token||""),{path:"/"});ddb.session("ddb_src_id",ddb.common.ddb_src_id||"");ddb.common.city_code=ddb.common.city_code||"0755";ddb.store("ddbCity",ddb.getCityByCode(ddb.common.city_code)+"/"+ddb.common.city_code);if(ddb.common.mobile&&ddb.common.user_id){ddb.session("appCommon",ddb.common)}else{ddb.session("appCommon",null)}}}return initApp})();ddb.appready=(function(){if(!ddb.isApp){return}var e=window.document;var b=!!window.DDBApp;var c=[],d;var f=setInterval(function(){if(window.DDBApp){clearInterval(f);a()}},50);e.addEventListener("DDBAppReady",d=function(){e.removeEventListener("DDBAppReady",d);a()});function a(g){b=1;while(g=c.shift()){g()}}return function(g){if(ddb.isApp){b?g():c.push(g)}}}());ddb.appCall=function(){if(!ddb.isApp){return}var b=arguments[0];var a=[].slice.call(arguments,1);ddb.appready(function(){ddb.app=window.DDBApp||window.android;try{a.length?ddb.app[b].apply(ddb.app,a):ddb.app[b]()}catch(c){alert(c)}})};if(ddb.isApp){ddb.appready(function(){ddb.app=window.DDBApp||window.android;if(!ddb.session("appCommon")){ddb.initApp()}try{if(ddb.app&&ddb.app.getEnv){ddb.dev_status=ddb.app.getEnv().replace(/\s+/g," ")||ddb.dev_status;ddb.sld=ddb.dev_status==="release"?"":ddb.dev_status+".";ddb.api="http://"+ddb.sld+"api.buskeji.com/"}}catch(a){}})}ddb.wx.hideShareMenu();$(window).on("load",function(){if(ddb.inPath("public|volunteer|chat")||ddb.wx.shared){return}ddb.wx.share({JSSDK_Share:{title:"美好生活从嗒嗒开始，百万豪礼大放送",desc:"嗒嗒巴士2周年庆，乘车礼券天天送，今天领完明天还能继续领哦。",link:"http://"+ddb.host+"/h5/active/lottery/index.html"}})});if(ddb.dev_status==="release"){(function(){var a=document.createElement("script");a.src="http://pingjs.qq.com/h5/stats.js";a.setAttribute("name","MTAH5");a.setAttribute("sid","500005480");a.setAttribute("cid","500005481");document.head.appendChild(a)})();$(document.body).on("click","[data-mtaid]",function(){if(!window.MtaH5){$(document).off("click","[data-mtaid]");return}var a=$.trim($(this).data("mtaid").toLowerCase());if(a.indexOf(" ")!==-1){a.split(" ").forEach(function(b){MtaH5.clickStat(b);console.log("上报统计："+b)})}else{if(a){MtaH5.clickStat(a);console.log("上报统计："+a)}}})}if(ddb.session("ddb_src_id")==="2128"){document.documentElement.classList.add("sogou-app");(function(){var a=document.createElement("script");a.src="http://fuwu.wap.sogou.com/static/partner.js";a.setAttribute("sogouid","085");document.head.appendChild(a)})()}document.addEventListener("DOMContentLoaded",function(){var c=document.documentElement;var a=document.getElementById("loadcover");if(a){ddb.hideLoadcover=function(){setTimeout(function(){a.className="hide-loadcover"},300);setTimeout(function(){a.parentNode.removeChild(a)},600)};if(a.getAttribute("data-hide")!=="none"){ddb.hideLoadcover()}}var b=$("button.newBack, .g-navbar .back");b.on("click",function(){window.history.go(-1)});$("html.doc").find("article dd:has(i)").addClass("has-index");if(B.url.getParam("from")==="tplMsg"||ddb.isApp){b.not(".forced-show").hide()}});
